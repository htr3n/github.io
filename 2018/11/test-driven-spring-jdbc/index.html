<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.51" />

    
    
    

<title>Back to basics: Test-driven Spring JDBC • htr3n&#39;s</title>
<meta name="description" content="htr3n&#39;s blog :: technology, thoughts, opinions, and rants">
<meta name="keywords" content="blog,java,php,python,golang,javascript,shell,thoughts,macos,apple,tiếng việt,parental,family,apache,httpd,laravel,politics,critical thinking,chính trị,luật,hiến pháp,xã hội,gia đình">






<meta name="twitter:card" content="summary"/>



<meta name="twitter:title" content="Back to basics: Test-driven Spring JDBC"/>
<meta name="twitter:description" content="A hand-on experience on JDBC programming can help to further understand many concepts and techniques of complex data access libraries. Besides, appropriate test cases might reveal some problematic usage or issues early on"/>



<meta property="og:title" content="Back to basics: Test-driven Spring JDBC" />
<meta property="og:description" content="A hand-on experience on JDBC programming can help to further understand many concepts and techniques of complex data access libraries. Besides, appropriate test cases might reveal some problematic usage or issues early on" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.test:8443/2018/11/test-driven-spring-jdbc/" />

  
    
      <meta property="og:image" content="https://blog.test:8443/2018/11/test-driven-spring-jdbc/ide-main.png" />
    
      <meta property="og:image" content="https://blog.test:8443/2018/11/test-driven-spring-jdbc/ide-step-1.png" />
    
      <meta property="og:image" content="https://blog.test:8443/2018/11/test-driven-spring-jdbc/ide-step-2.png" />
    
      <meta property="og:image" content="https://blog.test:8443/2018/11/test-driven-spring-jdbc/ide-step-3.png" />
    
      <meta property="og:image" content="https://blog.test:8443/2018/11/test-driven-spring-jdbc/ide-step-4.png" />
    
      <meta property="og:image" content="https://blog.test:8443/2018/11/test-driven-spring-jdbc/spring-overview.png" />
    
  



<meta property="article:published_time" content="2018-11-17T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2018-11-18T00:00:00&#43;00:00"/>
















    <link href="https://fonts.googleapis.com/css?family=Bitter|IBM+Plex+Serif" rel="stylesheet">





<link rel="stylesheet" href="https://blog.test:8443/scss/hyde-hyde.css" >


<link rel="stylesheet" href="https://blog.test:8443/scss/print.css" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.test:8443/">htr3n&#39;s</a>
      </span>
      
      
      
      <div class="author-image">
        <img src="https://blog.test:8443//img/avatar.png" alt="Author Image" class="img--circle img--headshot element--center">
      </div>
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">htr3n&#39;s</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/posts/">
						<span>Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/portfolio/">
						<span>Portfolio</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/vn/">
						<span>Tiếng Việt</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/htr3n" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/htr3n" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	<a href="https://linkedin.com/in/htr3n" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/339302" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://keybase.io/htr3n" rel="me"><i class="fab fa-keybase fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:hoang.huy.tran&#43;blog@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    <div class="copyright">
  &copy; 2018 htr3n.
  <a href="https://creativecommons.org/licenses/by-sa/4.0">Some Rights Reserved</a>.
  Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
  
</div>

  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Back to basics: Test-driven Spring JDBC</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Nov 17, 2018
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/dev">DEV</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/spring-framework">spring-framework</a>
           
      
          <a class="badge badge-tag" href="/tags/database">database</a>
           
      
          <a class="badge badge-tag" href="/tags/jdbc">jdbc</a>
           
      
          <a class="badge badge-tag" href="/tags/jdbctemplate">jdbctemplate</a>
           
      
          <a class="badge badge-tag" href="/tags/spring-boot">spring-boot</a>
           
      
          <a class="badge badge-tag" href="/tags/junit">junit</a>
           
      
          <a class="badge badge-tag" href="/tags/unit-test">unit-test</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 6 min read
</div>


  </header>
  
  
  <div class="post">
    

<p><a href="https://spring.io">Spring</a> is a popular heavy-weight framework for developing Java/Groovy based applications. Its rich libraries and software stack can cover from front-end to back-end development. In 2009 I used Spring Framework 3 to develop <a href="https://github.com/htr3n/loan-approval-portal">web services and MVC+Hibernate portal</a> for a fictious <a href="https://github.com/htr3n/loan-approval">loan approval process</a>. Despite a tad steep learning-curve, I could manage to get the services and portal up and running and integrated with third-party libraries quite smoothly.</p>

<p>In my prevous projects, I mostly used Spring with Hibernate and/or JPA for higher abstraction level of data access. Coming back to work with Spring after few years, I want to delve into lower layer of data access to better understand what behind the scene of Hibernate/JPA abstraction layers. This post is sort of my note-to-self on Spring and JDBC (Java Database Connectivity), especially on <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html">JdbcTemplate</a>. Besides, it also reports a tricky case with retrieving data with <code>JdbcTemplate.queryForObject()</code> employed by several on-line tutorials which is efficiently revealed by appropriate test cases.</p>

<h2 id="background">Background</h2>

<p>JDBC defines standard vendor-independent application programming interface (API) based on that a client can access a database. Each database vendor often provides low-level vendor-specific database drivers based on JDBC predefined interfaces. JDBC is considered the lowest recommended abstraction level to work with databases in Java.</p>

<p>In short, a typical approach to database access using JDBC comprises these basic steps:</p>

<ol>
<li>Obtain a <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html">Connection</a>, e.g. via <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/DriverManager.html">DriverManager</a> or <a href="https://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html">DataSource</a></li>
<li>Create an instance of type <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Statement.html">Statement</a> or its sub-types such as <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/CallableStatement.html">CallableStatement</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html">PreparedStatement</a></li>
<li>Use the aforementioned statement to execute database queries</li>
<li>(Optional) Retrieve and process the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html">ResultSet</a> (if any)</li>
<li>Close the statement and release all resources (connection is <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">AutoCloseable</a>)</li>
</ol>

<p>Along these steps, we should also handle any <a href="https://docs.oracle.com/javase/tutorial/jdbc/basics/sqlexception.html">database exceptions</a> as well. You can find more details on JDBC programming <a href="https://docs.oracle.com/javase/tutorial/jdbc/basics/index.html">here</a>.  Here is a simple example of accessing databases using JDBC and <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html"><em>try-with-resources</em></a>.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=JDBC.java"></script>

<p>Fortunately, Spring, via  <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html">JdbcTemplate</a>, ofters a higher level of abstraction on top of Java JDBC that would save us a lot of boiler plate code and enable smooth integration with the rest of Spring framework&rsquo;s ecosystem.As such, we can leverage other parts of Spring farmework, for instance, the awesome <a href="https://spring.io/projects/spring-boot">Spring Boot</a>, to automate lots of configuration effort.</p>

<h2 id="a-simple-crud-project-with-spring-jdbc">A simple CRUD project with Spring JDBC</h2>

<p>Nothing is better than a hand-on development project that demonstrate how Spring JDBC works. We can start with <a href="https://start.spring.io/">Spring Initialzr</a> and <a href="https://spring.io/projects/spring-boot">Spring Boot</a> to jump start and better concentrate on the main code instead of numerous dependencies and configurations.</p>

<p>There are a few ways to bootstrap our project with Spring Initialzr. Most of the popular Java IDE such as Eclipse or Intellij IDEA with Spring extensions can create a new project via Spring Initialzr. You can also achieve the same result from the web site <a href="https://start.spring.io">https://start.spring.io</a> or even using <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started-installing-spring-boot.html#getting-started-installing-the-cli">Spring Boot CLI</a>.</p>

<p>Here I will use Intellij IDEA for just showing the necessary steps and dependencies. You can use any of the aforementioned methods to obtain the same result.</p>

<p><strong>Step 1</strong>:</p>

<p>Create a new project and choose Spring Initialzr.</p>

<p><img src="ide-step-1.png" alt="" /></p>

<p><strong>Step 2</strong>:</p>

<p>Fill in necessary project information, keep default values for project&rsquo;s type (Maven), language (Java), packaging (Jar), Java version (8).</p>

<p><img src="ide-step-2.png" alt="" /></p>

<p><strong>Step 3</strong>:</p>

<p>Choose the section SQL and make sure the checkboxes of H2 and JDBC are ticked.</p>

<p><img src="ide-step-3.png" alt="" /></p>

<p><strong>Step 4</strong>:</p>

<p>Finish the project creation wizard.</p>

<p><img src="ide-step-4.png" alt="" /></p>

<p>After Step 4, Intellij IDEA will create a new Maven Spring Boot project with some initial source and configuration files.</p>

<p>By default, the main configuration file for Spring Boot is <code>application.properties</code>.</p>

<p><img src="ide-main.png" alt="" /></p>

<h3 id="defining-domain-entities">Defining Domain Entities</h3>

<p>We might not need a complex domain model but rather a simple entity mapped to a database table. For example, a <code>Customer</code> entity as shown in Java code and a corresponding <code>customer</code> table (will be automatically scanned and configured by Spring Boot).</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=Customer.java"></script>

<h3 id="configuring-database-connection">Configuring Database Connection</h3>

<p>At the other end, we need to define the connection with the underlying database. Again, Spring Boot helps us to ease the burden of configuring database. In this project, I will take example of <a href="https://github.com/h2database/h2database">H2</a>, an lightweight embeddable Java based RDBMS but any other databases should also work in the same way. A minimal configuration of H2 in <code>application.properties</code> is shown as following.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=application.properties"></script>

<p>Of  course we have also to initialise the database (otherwise Spring will complain that the table <code>customer</code> does not exist when our application or tests starts). By convention documented <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-initialize-a-database-using-spring-jdbc">here</a>, what we need to do is adding a file <code>schema.sql</code> in the folder <code>src/main/resources</code> and add a simple SQL script to create a talbe <code>customer</code>.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=schema.sql"></script>

<h3 id="test-driven-crud">Test-Driven CRUD</h3>

<p>At the heart of our JDBC project is a <code>CustomerDao.java</code> with basic <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD methods</a>. The class <code>CustomerDao</code> is annotated with <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/stereotype/Repository.html">@Repository</a> to indicate this is a data access component that is autodetected through Spring&rsquo;s classpath scanning.</p>

<p>As <code>JdbcTemplate</code> will be used to work with H2 database, we just declared an <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/annotation/Autowired.html">@Autowired</a> field, the rest will be taken care by Spring.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=CustomerDao.java"></script>

<h4 id="crud-unit-tests">CRUD Unit Tests</h4>

<p>Before starting implementing the CRUD methods, we create some unit tests in <code>CustomerDaoTest</code>. Again, Spring Boot will help us a lot here with setting up and shutting down the testing environment via annotations such as <code>@RunWith</code> and <code>@SpringBootTest</code>. We just need to declare an <em>auto-wired</em> object <code>CustomerDao</code>.</p>

<p>Moreover, Spring also provides useful annotations for database testing, for instance, <code>@Transational</code> and <code>@Rollback</code>. With these annotations, Spring will take care of database transactions as well as rollling back the testing databases to its initial state.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=CustomerDaoTest.java"></script>

<h4 id="crud-implementation">CRUD Implementation</h4>

<p>With the unit tests created, we can start implementing the CRUD using Spring <code>JdbcTemplate</code>.</p>

<p><strong>C</strong>reate</p>

<p>To satisfy <code>CustomerDaoTest.testCreate()</code> method, our <code>Customer.create()</code> must successfully store an input <code>Customer</code> and return with the auto-generated primary key (e.g. customer ID). In order to obtain the key, we can use Spring&rsquo;s helper class <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/support/KeyHolder.html"><code>KeyHolder</code></a> along with the standard <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html"><code>PreparedStatement</code></a>. Note that the code was simplified with <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">Java 8 Lambda notation</a>.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=create.java"></script>

<p>Note that, Spring also provides another helper, namely, <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/jdbc/core/simple/SimpleJdbcInsert.html"><code>SimpleJdbcInsert</code></a> with methods <code>executeAndReturnKey()</code>. Per documentation, <code>SimpleJdbcInsert</code>  is actually a higher level wrapper of <code>JdbcTemplate</code>.</p>

<p><strong>R</strong>etrieve</p>

<p>In our case, we implement two retrieval methods: <code>findAll()</code> will return a list of all customers whilst <code>findCustomerById()</code> will look for a certain customer using the input ID.</p>

<p>The method <code>findAll()</code> is rather a piece of cake but <code>findCustomerById()</code> is quite tricky. Most of the tutorials or guides on Spring <code>JdbcTemplate</code> I have found on the Internet use the method <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/JdbcTemplate.html#queryForObject-java.lang.String-java.lang.Class-">JdbcTemplate.queryForObject()</a> to look up for a database row. Trust me, I made the same mistake, too, along the line of this.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=problematic-findCustomerById.java"></script>

<p>Neater and cleaner, eh!? Unfortunately, the aforementioned <code>findCustomerById()</code> based on the problematic <code>JdbcTemplate.queryForObject()</code> will fail in case the query returns nothing (e.g. no existing customer with a certain ID). This issue has been exposed by <a href="https://github.com/htr3n/spring-jdbc-simple/blob/3a261893ac27c909b8728d625d564797fd6afc64/src/test/java/io/github/htr3n/springjdbcsimple/data/CustomerDaoTest.java#L45"><code>testFindCustomerById()</code></a> and I fixed it with a better version that uses <code>JdbcTemplate.query()</code> and checks for the returning <code>ResultSet</code>, in case of non-exiting customer yielding correctly <code>null</code>.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=retrieval.java"></script>

<p>Also note that, when working with pure JDBC, we must map the database query result onto the domain entity on our own. This can be quickly done by implementing the interface <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/core/RowMapper.html"><code>RowMapper&lt;T&gt;</code></a>.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=CustomerMapper.java"></script>

<p><strong>U</strong>pdate / <strong>D</strong>elete</p>

<p>The implementation of updating and deletion is rather straightforward.</p>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=update.java"></script>

<script type="application/javascript" src="//gist.github.com/htr3n/3c096c5de35a6c1b2564d8d0459b74fa.js?file=delete.java"></script>

<p>The <a href="https://github.com/htr3n/spring-jdbc-simple">project source code</a> is available on Github.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2018/08/notes-to-self-on-web-fonts-and-typography/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Notes to self on Web fonts and typography</span>
    </a>
    
    
    <a href="/2018/11/learning-to-react/" class="navigation-next">
      <span class="navigation-tittle">Learning to &#39;React&#39;</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  


<div class="post__related">
    
    <h2>Related Articles</h2>
    <ul class="related-posts">
        
<li>
  <span class="list__title--small">
    <a href="/2018/06/migrating-hibernate/">Hibernate: Migrating 3.x to 5.x</a>
      
      <time class="pull-right hidden-tablet">Jun 12 &#39;18</time>
      
  </span>
</li>

<li>
  <span class="list__title--small">
    <a href="/2018/06/on-spring-framework-part-1-the-core/">On Spring Framework: Part 1 - The Core</a>
      
      <time class="pull-right hidden-tablet">Jun 17 &#39;18</time>
      
  </span>
</li>

<li>
  <span class="list__title--small">
    <a href="/2018/06/spring-web-mvc/">Spring Web/MVC</a>
      
      <time class="pull-right hidden-tablet">Jun 17 &#39;18</time>
      
  </span>
</li>

<li>
  <span class="list__title--small">
    <a href="/2018/06/apache-cxf-2-to-3/">A journey from Apache CXF 2.2 to 3.2</a>
      
      <time class="pull-right hidden-tablet">Jun 15 &#39;18</time>
      
  </span>
</li>

    </ul>
</div>



  
    
        <div id="disqus_thread"></div>
<script type="text/javascript">
    

    (function () {
    if (location.hostname === "localhost" ||
      location.hostname === "127.0.0.1" ||
      location.hostname === "") {
      return;
    }
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    var disqus_shortname = 'https-htr3n-github-io';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || 
      document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<noscript>
  Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by
  <span class="logo-disqus">Disqus</span>
</a>

    


</article>


        </div>
        
    


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112764962-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>

<noscript id="deferred-styles">
  
  
</noscript>

<script>
  var loadDeferredStyles = function () {
    var addStylesNode = document.getElementById("deferred-styles");
    if (addStylesNode) {
      var replacement = document.createElement("div");
      replacement.innerHTML = addStylesNode.textContent;
      document.body.appendChild(replacement);
      addStylesNode.parentElement.removeChild(addStylesNode);
    }
  };
  var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
    window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
  if (raf) raf(function () {
    window.setTimeout(loadDeferredStyles, 0);
  });
  else
    window.addEventListener('load', loadDeferredStyles);
</script>





    



    </body>
</html>
